<html>
<head></head>
<body>

<button id="moreInfo">More Information</button>

<div id="pieChart"></div>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<!-- <script src="js/jquery-1.7.2.min.js"></script> -->
<script src="js/jquery-2.1.4.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.4/d3.min.js"></script>
<script src="js/d3pie.min.js"></script>
<script>
	$(document).ready(function() {

//Displays a pie chart showing DCO members sorted by affiliated DCO community
//Uses D3 and sample code from d3pie.org
//Author Stephen Moon
//Version 7/24/2015

var commNumbers = [];
var commNames = [];
var publicationCounts = [];
// FIXME: we need to add more colors in case there's more communities.
var colors = [ "#0c6197", "#248838", "#e98125", "#923e99", "#00fbe4", "#eb0ddc", "#f3f10b", "#990000", "#000000", "#515151"  ];

moreInfo.onclick = function()
{
	var segment = pie.getOpenSegment();
	if(segment === null)
	{
		alert("Please click on a piece of the pie, then re-click the button.");
	}
	else
	{
		var i = segment.data.num;
		var name = commNames[i];
		var members = segment.data.value;
		alert("The " + name + " has " + members + " members and " + publicationCounts[commNames[i]] + " publications." );
	}
};

function openURL(link)
{
$.ajax({
	dataType: "json",
	url: link,
	success: function(data) {
	for(var i = 0; i < data.results.bindings.length; i++)
	{
        // we know the dcocommname from the first query that grabs member counts for the communities
        // so we can use key/value paris in publicationCounts to store the number of publications
        // for that community. This is instead of relying on ordering of the second query results to be
        // the same as the first query results.
		publicationCounts[data.results.bindings[i].dcocommname.value] = parseInt(data.results.bindings[i].number.value);
	}
	}
	});
}

$.ajax({
	dataType: "json",
    // url: "statsJSON/dcoStats.json",
    url: "statsJSON/communityMemberCounts1.json",
    //url: 'https://info.deepcarbon.net/vivo/admin/sparqlquery?query=PREFIX+rdfs%3A++%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0D%0APREFIX+dco%3A+%3Chttp%3A%2F%2Finfo.deepcarbon.net%2Fschema%23%3E%0D%0APREFIX+foaf%3A+%3Chttp%3A%2F%2Fxmlns.com%2Ffoaf%2F0.1%2F%3E%0D%0APREFIX+obo%3A+%3Chttp%3A%2F%2Fpurl.obolibrary.org%2Fobo%2F%3E%0D%0APREFIX+vivo%3A+%3Chttp%3A%2F%2Fvivoweb.org%2Fontology%2Fcore%23%3E%0D%0A%0D%0A%23This+query+gets+the+names+of+each+DCO+community+and+counts+the+number+of+users+in+%0D%0A%23each+community%0D%0ASELECT+%3Fdcocommname+%28COUNT%28%3Fuser%29+as+%3Fnumber%29+WHERE%0D%0A%7B%0D%0A++++%3Fuser+a+foaf%3APerson+.%0D%0A+++++%3Fuser+%3Chttp%3A%2F%2Fvivo.mydomain.edu%2Fns%23networkId%3E+%3FnetID+.%0D%0A+++++%3Fuser+obo%3ARO_0000053+%3Fcommrole+.%0D%0A+++++%3Fcommrole+a+vivo%3AMemberRole+.%0D%0A++++OPTIONAL+%7B+%3Fcommrole+vivo%3AdateTimeINterval+%3Finterval+.%0D%0A+++++++++++++++++++++++++%3Finterval+vivo%3Aend+%3Fend+.+%7D%0D%0A++++FILTER%28%21BOUND%28%3Fend%29%29%0D%0A++++%3Fcommrole+vivo%3AroleContributesTo+%3Fdco_community+.%0D%0A++++%3Fdco_community+a+dco%3AResearchCommunity+.%0D%0A++++%3Fdco_community+rdfs%3Alabel+%3Fdcocommname+.%0D%0A%7D%0D%0AGROUP+BY+%3Fdcocommname%0D%0A&resultFormat=RS_JSON&rdfResultFormat=RDF%2FXML-ABBREV',
	success: function(data) {
        // theQueryResult = data.communityMemberCounts1;
        theQueryResult = data;
        // console.log(theQueryResult);

		for(var i = 0; i < theQueryResult.results.bindings.length; i++)
		{
			updateNumbers(parseInt(theQueryResult.results.bindings[i].number.value));
			updateNames(theQueryResult.results.bindings[i].dcocommname.value);
		}

		pie = generateChart(commNames,commNumbers);
		//Opens the publication count first and stores results in publicationCounts
        openURL("statsJSON/communityMemberCounts2.json");
        //openURL("https://info.deepcarbon.net/vivo/admin/sparqlquery?query=PREFIX+rdfs%3A++%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0D%0APREFIX+dco%3A+%3Chttp%3A%2F%2Finfo.deepcarbon.net%2Fschema%23%3E%0D%0APREFIX+bibo%3A+%3Chttp%3A%2F%2Fpurl.org%2Fontology%2Fbibo%2F%3E%0D%0A%0D%0A%23%0D%0A%23Counts+the+number+of+publications+on+the+DCO+website%0D%0A%23Sorts+the+publications+by+DCO+community%0D%0A%23%0D%0ASELECT+%3Fdcocommname+%28COUNT%28%3Fpublication%29+as+%3Fnumber%29+WHERE%0D%0A%7B%0D%0A%7B+%3Fpublication+a+bibo%3AArticle+.+%7D+%0D%0AUNION+%7B+%3Fpublication+a+bibo%3ABook+.+%7D+%0D%0AUNION+%7B+%3Fpublication+a+bibo%3ADocumentPart+.+%7D+%0D%0AUNION+%7B+%3Fpublication+a+dco%3APoster+.+%7D+%0D%0AUNION+%7B+%3Fpublication+a+bibo%3AThesis+.+%7D%0D%0A%3Fpublication+dco%3AassociatedDCOCommunity+%3Fdcocomm.%0D%0A%3Fdcocomm+rdfs%3Alabel+%3Fdcocommname.%0D%0A%7D%0D%0AGROUP+BY+%3Fdcocommname&resultFormat=RS_JSON&rdfResultFormat=RDF%2FXML-ABBREV");
	}
});

function updateNumbers(number) {
	commNumbers.push(number);
};

function updateNames(name) {
	commNames.push(name);
};

//Right now, the full names stored in commNames are not used because some are too big
//to fit onscreen. However, they are still stored for use in other queries.
function generateChart(commNames,commNumbers) {
    var json = {
		"header": {
			"title": {
				"text": "Members Sorted by Affiliated Community",
				"fontSize": 24,
				"font": "open sans"
			},
			"subtitle": {
				"text": "Deep Carbon Observatory",
				"color": "#999999",
				"fontSize": 16,
				"font": "open sans"
			},
			"titleSubtitlePadding": 9
		},
		"footer": {
			"color": "#999999",
			"fontSize": 10,
			"font": "open sans",
			"location": "bottom-left"
		},
		"size": {
			"canvasWidth": 590,
			"pieInnerRadius": "35%",
			"pieOuterRadius": "90%"
		},
		"data": {
			"sortOrder": "label-desc",
			"content": [
			]
		},
		"labels": {
			"outer": {
				"pieDistance": 32
			},
			"inner": {
				"hideWhenLessThanPercentage": 3
			},
			"mainLabel": {
				"fontSize": 11
			},
			"percentage": {
				"color": "#ffffff",
				"decimalPlaces": 1
			},
			"value": {
				"color": "#adadad",
				"fontSize": 11
			},
			"lines": {
				"enabled": true
			},
			"truncation": {
				"enabled": false
			}
		},
		"effects": {
			"pullOutSegmentOnClick": {
				"effect": "linear",
				"speed": 400,
				"size": 16
			}
		},
		"misc": {
			"gradient": {
				"enabled": true,
				"percentage": 100
			}
		}
    };

    // we now have the basic structure and can add the data returned from the first query
    for( var i = 0; i < commNames.length; i++ )
    {
        json.data.content.push( {
            "label": commNames[i],
            "value": commNumbers[i],
            "color": colors[i],
            "num": i
        } );
    }

    return new d3pie("pieChart",json);
};

});
</script>

</body>
</html>
